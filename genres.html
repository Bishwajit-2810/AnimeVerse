<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Genres â€” AnimeVerse</title>

    <link rel="stylesheet" href="assets/css/reset.css" />
    <link rel="stylesheet" href="assets/css/style.css" />
  </head>

  <body>
    <!-- HEADER -->
    <div class="header-wrap">
      <header class="header container">
        <div style="display: flex; align-items: center; gap: 12px">
          <button id="mobile-nav-toggle" class="mobile-nav-toggle">â˜°</button>

          <a
            href="index.html"
            class="brand"
            style="text-decoration: none; color: inherit"
          >
            <span class="logo"></span> AnimeVerse
          </a>
        </div>

        <nav class="nav" id="main-nav" aria-label="Main navigation">
          <a href="index.html">Home</a>
          <a href="trending.html">Trending</a>
          <a href="genres.html" class="active">Genres</a>
          <a href="favorites.html">Favorites</a>
          <a href="about.html">About</a>
        </nav>

        <div style="display: flex; align-items: center; gap: 10px">
          <div class="search-wrap">
            <button id="search-open" class="search-toggle">ğŸ”</button>
            <input
              id="nav-search-input"
              class="search-input"
              type="search"
              placeholder="Search anime (press S)..."
            />
            <button id="voice-btn" class="search-toggle">ğŸ¤</button>
            <div id="suggestions" class="suggestions"></div>
          </div>

          <div class="controls">
            <button
              id="theme-toggle"
              onclick="animeverseToggleTheme()"
              class="pill"
            >
              ğŸŒ“
            </button>
          </div>
        </div>
      </header>
    </div>

    <!-- PAGE CONTENT WRAPPER (IMPORTANT FOR BLUR) -->
    <div id="page-content">
      <main class="page container">
        <h1>Genres</h1>

        <p style="color: var(--muted); margin-top: 6px; margin-bottom: 16px">
          Tap any genre to explore related anime.
        </p>

        <div id="genres" class="card-grid"></div>
      </main>

      <!-- FOOTER -->
      <footer class="footer container">
        <p style="color: var(--muted)">Â© AnimeVerse</p>
      </footer>
    </div>
    <!-- /#page-content -->

    <!-- AGE CONFIRMATION POPUP (hidden by default) -->
    <div
      id="adult-popup"
      class="adult-popup hidden"
      aria-hidden="true"
      role="dialog"
      aria-modal="true"
    >
      <div class="adult-box" role="document" aria-label="Age confirmation">
        <h2 style="margin: 0 0 8px">ğŸ” Adult Content</h2>

        <p style="color: var(--muted); margin: 0 0 14px">
          This genre includes adult or explicit material. Are you 18 years of
          age or older?
        </p>

        <div class="remember-row">
          <input type="checkbox" id="remember-choice" />
          <span>Remember my choice</span>
        </div>

        <div class="adult-buttons">
          <button id="adult-yes" class="btn primary" style="min-width: 120px">
            Yes, I am 18+
          </button>
          <button id="adult-no" class="btn secondary" style="min-width: 120px">
            No
          </button>
        </div>
      </div>
    </div>

    <!-- SCRIPTS -->
    <script src="assets/js/api.js"></script>
    <script src="assets/js/theme.js"></script>
    <script src="assets/js/app.js"></script>

    <script>
      /* ------- ADULT GENRE GATING (works only if page-content exists, fallback to body) ------- */

      const ADULT_GENRES = ["Hentai", "Erotica", "Ecchi", "Harem"];

      const popup = document.getElementById("adult-popup");
      const page = document.getElementById("page-content") || document.body;

      let pendingGenreId = null;

      function isAdultVerified() {
        return localStorage.getItem("adult-ok") === "true";
      }

      function markAdultVerified() {
        localStorage.setItem("adult-ok", "true");
      }

      /* -----------------------------
     FIXED: safe popup hide handler
     ----------------------------- */
      function safeHidePopup() {
        // remove focus BEFORE hiding to prevent aria-hidden error
        if (document.activeElement) {
          document.activeElement.blur();
        }

        popup.classList.add("hidden");
        popup.setAttribute("aria-hidden", "true");
        page.classList.remove("blur-active");
        document.documentElement.style.overflow = "";
      }

      (async () => {
        const out = document.getElementById("genres");
        try {
          out.innerHTML = `<div style="color:var(--muted);padding:20px">Loadingâ€¦</div>`;
          const list = await fetchGenres();

          if (!list || !list.length) {
            out.innerHTML = `<div style="color:var(--muted)">Failed to load genres.</div>`;
            return;
          }

          out.innerHTML = list
            .map((g) => {
              const isAdult = ADULT_GENRES.includes(g.name);
              return `
            <a class="card genre-card"
               data-genre-id="${g.mal_id}"
               data-genre-name="${esc(g.name)}"
               data-adult="${isAdult}"
               href="#"
               style="padding:16px;text-align:center;font-weight:700;display:flex;justify-content:center;align-items:center;height:90px">
              ${esc(g.name)} ${isAdult ? "ğŸ”" : ""}
            </a>`;
            })
            .join("");
        } catch (err) {
          console.error("Genres load error:", err);
          out.innerHTML = `<div style="color:var(--muted)">Error loading genres.</div>`;
        }
      })();

      document.addEventListener("click", function (e) {
        const card = e.target.closest(".genre-card");
        if (!card) return;

        e.preventDefault();

        const id = card.dataset.genreId;
        const isAdult = card.dataset.adult === "true";

        if (!isAdult) {
          location.href = `trending.html?genre=${id}`;
          return;
        }

        if (isAdultVerified()) {
          location.href = `trending.html?genre=${id}`;
          return;
        }

        pendingGenreId = id;
        showAdultPopup();
      });

      function showAdultPopup() {
        popup.classList.remove("hidden");
        popup.setAttribute("aria-hidden", "false");
        page.classList.add("blur-active");
        document.documentElement.style.overflow = "hidden";
      }

      /* -----------------------------
     UPDATED: use safeHidePopup()
     ----------------------------- */
      document
        .getElementById("adult-yes")
        .addEventListener("click", function () {
          if (document.getElementById("remember-choice").checked) {
            markAdultVerified();
          }

          safeHidePopup();

          if (pendingGenreId) {
            location.href = `trending.html?genre=${pendingGenreId}`;
          }
        });

      document
        .getElementById("adult-no")
        .addEventListener("click", function () {
          safeHidePopup();
          pendingGenreId = null;
        });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && !popup.classList.contains("hidden")) {
          safeHidePopup();
          pendingGenreId = null;
        }
      });
    </script>
  </body>
</html>
