<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon.png" />
    <title>Anime Details ‚Äî AnimeVerse</title>
    <link rel="stylesheet" href="assets/css/reset.css" />
    <link rel="stylesheet" href="assets/css/style.css" />
  </head>

  <body>
    <!-- HEADER -->
    <div class="header-wrap">
      <header class="header container">
        <div style="display: flex; align-items: center; gap: 12px">
          <button id="mobile-nav-toggle" class="mobile-nav-toggle">‚ò∞</button>
          <a
            href="index.html"
            class="brand"
            style="
              text-decoration: none;
              color: inherit;
              display: flex;
              align-items: center;
              gap: 10px;
            "
          >
            <img
              src="assets/images/favicon.png"
              alt="AnimeVerse Logo"
              style="
                width: 22px;
                height: 22px;
                border-radius: 50%;
                object-fit: cover;
              "
            />
            AnimeVerse
          </a>
        </div>

        <nav class="nav" id="main-nav">
          <a href="index.html">Home</a>
          <a href="trending.html">Trending</a>
          <a href="genres.html">Genres</a>
          <a href="favorites.html">Favorites</a>
          <a href="about.html">About</a>
        </nav>

        <div style="display: flex; align-items: center; gap: 10px">
          <div class="search-wrap">
            <button id="search-open" class="search-toggle">üîç</button>
            <input
              id="nav-search-input"
              class="search-input"
              type="search"
              placeholder="Search anime (press S)..."
            />
            <button id="voice-btn" class="search-toggle">üé§</button>
            <div id="suggestions" class="suggestions"></div>
          </div>

          <div class="controls">
            <button
              id="theme-toggle"
              onclick="animeverseToggleTheme()"
              class="pill"
            >
              üåì
            </button>
          </div>
        </div>
      </header>
    </div>

    <!-- PAGE CONTENT -->
    <main class="page container" id="content">
      <div style="padding: 40px; color: var(--muted)">Loading‚Ä¶</div>
    </main>

    <footer class="footer container">
      <p style="color: var(--muted)">¬© AnimeVerse</p>
    </footer>

    <!-- scripts -->
    <script src="assets/js/api.js"></script>
    <script src="assets/js/theme.js"></script>
    <script src="assets/js/app.js"></script>

    <script>
      (async () => {
        const id = new URLSearchParams(location.search).get("id");
        const root = document.getElementById("content");

        if (!id) {
          root.innerHTML = "<p>Missing anime ID.</p>";
          return;
        }

        const data = await fetchAnimeDetails(id);
        if (!data) {
          root.innerHTML = "<p>Anime not found.</p>";
          return;
        }

        const [characters, staff, recommendations, themes] = await Promise.all([
          fetchAnimeCharacters(id),
          fetchAnimeStaff(id),
          fetchAnimeRecommendations(id),
          fetchAnimeThemes(id),
        ]);

        const poster =
          data.images?.jpg?.large_image_url || "assets/images/placeholder.jpg";
        const title = esc(data.title);
        const score = data.score || "N/A";
        const episodes = data.episodes || "N/A";
        const synopsis = esc(data.synopsis || "No synopsis available.");

        function renderFavBtn() {
          const added = isFavorite(data.mal_id);
          return `
            <button id="fav-btn" class="btn ${
              added ? "favorite-active" : ""
            }" style="margin-top:14px;width:100%">
              ${
                added
                  ? "‚ù§Ô∏è Added to Favorites (click to remove)"
                  : "ü§ç Add to Favorites"
              }
            </button>
          `;
        }

        /* ===== TAB BAR ===== */
        root.innerHTML = `
          <div class="anime-tabs">
            <button class="anime-tab active" data-target="about-section">About</button>
            <button class="anime-tab" data-target="themes-section">Themes</button>
            <button class="anime-tab" data-target="char-section">Characters</button>
            <button class="anime-tab" data-target="staff-section">Staff</button>
            <button class="anime-tab" data-target="recommend-section">Recommendations</button>
          </div>
        `;

        /* ABOUT */
        root.innerHTML += `
          <div id="about-section" class="tab-section active">
            <div class="anime-details-grid">
              <div>
                <img src="${poster}" class="poster-lg" />
                <div class="details-buttons">
                  ${renderFavBtn()}
                  <a class="btn secondary" href="https://myanimelist.net/anime/${
                    data.mal_id
                  }" target="_blank">View on MAL</a>
                </div>
              </div>

              <div class="anime-details-text">
                <h1>${title}</h1>

                <div class="meta-block">
                  ‚≠ê <b>${score}</b> ‚Ä¢ Episodes: ${episodes} ‚Ä¢ Type: ${
          data.type || "‚Äî"
        } ‚Ä¢ Status: ${data.status || "‚Äî"}
                </div>

                <div class="meta-list">
                  <div><b>Japanese:</b> ${esc(data.title_japanese || "‚Äî")}</div>
                  <div><b>English:</b> ${esc(data.title_english || "‚Äî")}</div>
                  <div><b>Season:</b> ${
                    data.season ? data.season + " " + data.year : "‚Äî"
                  }</div>
                  <div><b>Duration:</b> ${data.duration || "‚Äî"}</div>
                  <div><b>Rating:</b> ${data.rating || "‚Äî"}</div>
                  <div><b>Studios:</b> ${
                    data.studios?.map((s) => esc(s.name)).join(", ") || "‚Äî"
                  }</div>
                </div>

                <h3 style="margin-top:20px">Synopsis</h3>
                <p style="color:var(--muted);line-height:1.6;margin-top:6px">${synopsis}</p>

                ${
                  data.trailer?.embed_url
                    ? `<div class="trailer-box"><h3>Trailer</h3>
                       <iframe src="${data.trailer.embed_url}" class="trailer-frame" allowfullscreen></iframe></div>`
                    : ""
                }
              </div>
            </div>
          </div>
        `;

        /* CHARACTERS */
        root.innerHTML += `
          <section class="section tab-section" id="char-section">
            <h2>Characters</h2>
            <div class="card-grid">
              ${
                characters?.length
                  ? characters
                      .map(
                        (c) => `
                      <div class="card">
                        <img class="poster" src="${
                          c.character.images.jpg.image_url
                        }">
                        <div class="card-body">
                          <div class="card-title">${esc(c.character.name)}</div>
                          <div class="card-meta">${c.role}</div>
                        </div>
                      </div>`
                      )
                      .join("")
                  : "<p>No characters available.</p>"
              }
            </div>
          </section>
        `;

        /* STAFF */
        root.innerHTML += `
          <section class="section tab-section" id="staff-section">
            <h2>Staff</h2>
            <div class="card-grid">
              ${
                staff?.length
                  ? staff
                      .slice(0, 12)
                      .map(
                        (s) => `
                      <div class="card">
                        <img class="poster" src="${
                          s.person.images.jpg.image_url
                        }">
                        <div class="card-body">
                          <div class="card-title">${esc(s.person.name)}</div>
                          <div class="card-meta">${s.positions.join(", ")}</div>
                        </div>
                      </div>`
                      )
                      .join("")
                  : "<p>No staff available.</p>"
              }
            </div>
          </section>
        `;

        /* THEMES */
        root.innerHTML += `
          <section class="section tab-section" id="themes-section">
            <h2>Theme Songs</h2>
            <div style="color:var(--muted)">
              <b>Openings:</b><br>${
                themes?.openings?.length
                  ? themes.openings.map((t) => "‚Ä¢ " + esc(t)).join("<br>")
                  : "None"
              }
              <br><br>
              <b>Endings:</b><br>${
                themes?.endings?.length
                  ? themes.endings.map((t) => "‚Ä¢ " + esc(t)).join("<br>")
                  : "None"
              }
            </div>
          </section>
        `;

        /* RECOMMENDATIONS (LAST TAB) */
        root.innerHTML += `
          <section class="section tab-section" id="recommend-section">
            <h2>Recommended Anime</h2>
            <div class="card-grid">
              ${
                recommendations?.length
                  ? recommendations
                      .slice(0, 12)
                      .map(
                        (r) => `
                      <a class="card" href="anime.html?id=${r.entry.mal_id}">
                        <img class="poster" src="${
                          r.entry.images.jpg.image_url
                        }">
                        <div class="card-body"><div class="card-title">${esc(
                          r.entry.title
                        )}</div></div>
                      </a>`
                      )
                      .join("")
                  : "<p>No recommendations available.</p>"
              }
            </div>
          </section>
        `;

        /* FAVORITE BUTTON */
        const favBtn = document.getElementById("fav-btn");
        favBtn.onclick = () => {
          const added = toggleFavorite(data.mal_id);
          favBtn.textContent = added
            ? "‚ù§Ô∏è Added to Favorites (click to remove)"
            : "ü§ç Add to Favorites";
          favBtn.classList.toggle("favorite-active");
        };

        /* TAB SWITCHING */
        document.querySelectorAll(".anime-tab").forEach((btn) =>
          btn.addEventListener("click", () => {
            document
              .querySelectorAll(".anime-tab")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");

            document
              .querySelectorAll(".tab-section")
              .forEach((s) => s.classList.remove("active"));
            document.getElementById(btn.dataset.target).classList.add("active");
          })
        );
      })();
    </script>
  </body>
</html>
